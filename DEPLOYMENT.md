# Deployment (Short Version)

PondPilot can be deployed at the domain root (`/`) or under a subdirectory (`/ui/`, `/pondpilot/`). This document keeps only the essentials.

## 1. Base Path

Build-time environment variable: `VITE_BASE_PATH` (must start AND end with `/`). Default: `/`.

Examples:

```bash
VITE_BASE_PATH=/ui/ yarn build
just docker-build /ui/
```

The `just docker-build` command auto-normalizes the path.

## 2. What the Build Does

- `vite.config.mjs`: sets `base` from `VITE_BASE_PATH` (affects asset URLs).
- Vite exposes `import.meta.env.BASE_URL` (used as React Router `basename`).
- PWA manifest uses the same value as `start_url` to launch correctly from the subdirectory.

## 3. Nginx (Two Options)

### Option A (recommended) – Strip the prefix in the reverse proxy

```nginx
location = /ui { return 301 "/ui/"; }
location /ui/ {
  proxy_pass http://pondpilot:80/; # trailing slash strips /ui/
  proxy_set_header Host $host;
}
```

### Option B – Keep the prefix, rewrite inside the container

Outer proxy:

```nginx
location /ui/ { proxy_pass http://pondpilot:80; }
```

Container `nginx.conf`:

```nginx
location /ui/ {
  rewrite ^/ui/(.*)$ /$1 break;
  try_files $uri $uri/ /index.html;
}
```

Why one of these is required: built files live at root (`/assets/...`). Without prefix stripping or rewrite, `/ui/assets/...` requests 404.

## 4. Docker Compose (Example)

```yaml
services:
  pondpilot:
    image: pondpilot:latest
  nginx:
    image: nginx:alpine
    ports: ["80:80"]
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on: [pondpilot]
```

## 5. Local Development

```bash
VITE_BASE_PATH=/ui/ yarn dev
open http://localhost:5173/ui/
```

## 6. Common Issues

- 404 assets: forgot `proxy_pass .../` (no trailing slash) or missing rewrite.
- Blank page: check Network tab for missing JS → fix proxy config.
- Wrong path: missing trailing `/` on build variable (now auto-normalized, but double-check).

## 7. Terminology

- `VITE_BASE_PATH` – build-time env var.
- `import.meta.env.BASE_URL` – runtime value generated by Vite.
- `start_url` – PWA launch URL (must match base path).

This is enough for correct deployment. For rationale, see the PR history.

